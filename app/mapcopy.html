<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <!-- add title -->
    <title>Choropleth trackingData Tracking</title>

    <!-- import required libraries here -->
    <script type="text/javascript" src="/app/lib/d3-dsv.min.js"></script>
    <script type="text/javascript" src="/app/lib/d3.v5.min.js"></script>
    <script
      type="text/javascript"
      src="/app/lib/d3-geo-projection.v2.min.js"
    ></script>
    <script type="text/javascript" src="/app/lib/d3-legend.min.js"></script>
    <script type="text/javascript" src="/app/lib/d3-tip.min.js"></script>
    <script type="text/javascript" src="/app/lib/topojson.v2.min.js"></script>

    <style>
      /* define CSS rules here */
    </style>
  </head>

  <body>
    <!-- Add heading for the visualization -->

    <!-- Create dropdown element here. Options should be added after reading in trackingData_trafficking file, they should not be created here.-->
    <select id="yearDropdown">
      <option value="2015">2015</option>
      <option value="2016">2016</option>
      <option value="2017">2017</option>
      <option value="2018">2018</option>
      <option value="2019">2019</option>
      <option value="2020">2020</option>
      <option value="2021">2021</option>
      <option value="2022">2022</option>
      <option value="2023">2023</option>
      <option value="2024">2024</option>
    </select>

    <svg id="choropleth" width="1200" height="800"></svg>
    <!-- <div id="tooltip" class="d3-tip"></div> -->

    <script type="text/javascript">
      // enter code to define margin and dimensions for svg
      var margin = 20;
      var width = 1200;
      var height = 800;

      // enter code to create svg

      // enter code to create color scale

      // enter code to define tooltip

      // enter code to define projection and path required for Choropleth
      // For grading, set the name of functions for projection and path as "projection" and "path"
      // var projection =

      var projection = d3.geoNaturalEarth();
      // .scale(250)
      // .center([0,20])
      // .translate([width / 2, height / 2]);

      var path = d3.geoPath().projection(projection);
      var colorScale = d3.scaleQuantile();

      //Year,Country of Incident,Number_of_Incidents,Average_Fine,Average_Imprisonment
      var trackingDataPromise = d3.csv(
        "/data/wildlife_trafficking.csv",
        (d) => {
          return {
            year: d["Year"],
            country: d["Country"],
            incidents: d["Number_of_Incidents"],
            averageFine: d["Average_Fine"],
            averageImprisonment: d["Average_Imprisonment"],
          };

          // Year,Country,Number_of_Incidents,Average_Fine,Average_Imprisonment
        }
      );
      var countriesPromise = d3.json("/data/world_countries.json");

      // define any other global variables

      Promise.all([trackingDataPromise, countriesPromise]).then(ready);

      // this function should be called once the data from files have been read
      // world: topojson from world_countries.json
      // traffickingData: data from trackingData_trafficking.csv

      function ready(values) {
        var traffickingData = values[0];
        var world = values[1];

        var years = [...new Set(traffickingData.map((d) => d.year))].sort();

        document
          .getElementById("yearDropdown")
          .addEventListener("change", (event) => {
            let year = event.target.value;
            createMapAndLegend(world, traffickingData, year);
          });

        createMapAndLegend(world, traffickingData, years[0]);
      }

      // this function should create a Choropleth and legend using the world and traffickingData arguments for a selectedYear
      // also use this function to update Choropleth and legend when a different year is selected from the dropdown
      function createMapAndLegend(world, traffickingData, selectedYear) {
        let mouseOver = function (d) {
          d3.selectAll(".Country")
            .transition()
            .duration(200)
            .style("opacity", 0.5);
          d3.select(this)
            .transition()
            .duration(200)
            .style("opacity", 1)
            .style("stroke", "black");
        };

        let mouseLeave = function (d) {
          d3.selectAll(".Country")
            .transition()
            .duration(200)
            .style("opacity", 0.8);
          d3.select(this)
            .transition()
            .duration(200)
            .style("stroke", "transparent");
        };

        let domain = traffickingData
          .filter((d) => d.year == selectedYear)
          .map((d) => d.incidents);

        colorScale.range(d3.schemeReds[4]);
        colorScale.domain(domain);
        d3.selectAll("g").remove();

        var svg = d3.select("svg");
        svg
          .append("g")
          .attr("id", "countries")
          .selectAll("path")
          .data(world.features)
          .enter()
          .append("path")
          // .attr("class", "Country")
          // draw each country
          .attr("d", path)
          // set the color of each country
          .exit();
      }
    </script>
  </body>
</html>
